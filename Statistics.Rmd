---
title: "Statistics"
author: "Raju Adhikari"
date: "February 25, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, echo=FALSE}
#Loading all the necessary packages
library(bea.R)
library(acs)
library(magrittr)
library(httr)
library(tidyr)
library(blsAPI)
library(rjson)
library(readxl)
library(dplyr)

library(jsonlite)
library(stringr)


#Setting the working directory
setwd("C:/RajuPC/MPP Final Thesis/MPP_Thesis_Adhikari")

#All the keys for different APIs obtained from the respective websites
blskey <- "a9e62413e38741b5aeb814efc5a3d066"
beaKey <- 'C3812F4D-F498-40F8-9F36-9FF5AF65DBD7'
censusKey <- "c7ed765d1b03f4217ccc4b37d31b0dc3580db44e"
datagovkey <- "ubFrNGonfwMQm3lK04C6djaMcqFuIe5mvev4RooI"

```

```{r electiondata, echo=FALSE, include=FALSE}
#Voteshare Data (1992-2016)
voteshare_new <- read.table(file = 'full-us-presidential-counties-1960-2016.tsv', sep = '\t', header = TRUE)
voteshare_recent <- voteshare_new[voteshare_new$year >= "1992",] #Choosing years after 1992
voteshare_recent <- voteshare_recent[voteshare_recent$year < "2016",] #Removing year 2016

#Separating the democrats data and republicans data into separate dataframes
voteshare_recent_rep <- voteshare_recent [voteshare_recent$party == "R", ]
names(voteshare_recent_rep)[names(voteshare_recent_rep)=="vote.percent"] <- "rep.percent"
names(voteshare_recent_rep)[names(voteshare_recent_rep)=="vote.count"] <- "rep.count"
names(voteshare_recent_rep)[names(voteshare_recent_rep)=="is.national.winner"] <- "is.rep.nat.winner"
names(voteshare_recent_rep)[names(voteshare_recent_rep)=="national.party.count"] <- "nat.rep.count"
names(voteshare_recent_rep)[names(voteshare_recent_rep)=="national.party.percent"] <- "nat.rep.percent"

voteshare_recent_rep$party <- NULL

voteshare_recent_dem <- voteshare_recent [voteshare_recent$party == "D", ]
names(voteshare_recent_dem)[names(voteshare_recent_dem)=="vote.percent"] <- "dem.percent"
names(voteshare_recent_dem)[names(voteshare_recent_dem)=="vote.count"] <- "dem.count"
names(voteshare_recent_dem)[names(voteshare_recent_dem)=="is.national.winner"] <- "is.dem.nat.winner"
names(voteshare_recent_dem)[names(voteshare_recent_dem)=="national.party.count"] <- "nat.dem.count"
names(voteshare_recent_dem)[names(voteshare_recent_dem)=="national.party.percent"] <- "nat.dem.percent"

voteshare_recent_dem$party <- NULL

#Merging the two dataframes
election_data <- merge(voteshare_recent_rep, voteshare_recent_dem, all.x = T)

#Renaming column names to merge them with other data later
names(election_data)[names(election_data)=="state.abb"] <- "state"
names(election_data)[names(election_data)=="county.name"] <- "county"

#Converting the county and state columns from factors into strings so that they can be merged with other dataframes later
election_data$county <- as.character(election_data$county)
election_data$state <- as.character(election_data$state)

#Removing untidy dataframes from the environment
rm(voteshare_new, voteshare_recent, voteshare_recent_rep, voteshare_recent_dem)

```


```{r beadata, echo=FALSE, include=FALSE}
#BEA Regional Income Data: Population by county 
##2016 Data is not available
beaPop <- list(
    'UserID' = beaKey ,
    'Method' = 'GetData',
    'datasetname' = 'RegionalIncome',
    'TableName' = 'CA1' ,
    'LineCode' = '2',
    'Year' = '1992, 1996, 2000, 2004, 2008, 2012' ,
    'GeoFips' = 'COUNTY' ,
    'ResultFormat' = 'json'
)
beaPop <- beaGet(beaPop, asString = T, asTable = F)
Population <- jsonlite::fromJSON(beaPop)$BEAAPI$Results$Data %>%
  mutate(DataValue = ifelse(DataValue == '(NA)', NA, DataValue),
         DataValue = as.numeric(DataValue)) %>%
  rename(Year = TimePeriod, Pop = DataValue) %>%
  mutate(Year = as.numeric(Year))
# names(beaPop)[6:11]<-c("1992", "1996", "2000", "2004", "2008", "2012")
# Population <- gather(beaPop, 6:11, key="Year", value="Pop")
# names(Population)[4]<-"Pop_Label"
rm(beaPop)


#BEA Regional Income Data: Per Capita Income by county
beaPCI <- list(
    'UserID' = beaKey ,
    'Method' = 'GetData',
    'datasetname' = 'RegionalIncome',
    'TableName' = 'CA1' ,
    'LineCode' = '3',
    'Year' = '1992, 1996, 2000, 2004, 2008, 2012' ,
    'GeoFips' = 'COUNTY' ,
    'ResultFormat' = 'json'
);
beaPCI <- beaGet(beaPCI)
names(beaPCI)[6:11]<-c("1992", "1996", "2000", "2004", "2008", "2012")
PerCapitaIncome <- gather(beaPCI, 6:11, key="Year", value="PCI")
names(PerCapitaIncome)[4]<-"PCI_Label"


#Make sure NAs don't turn into 0.
#The data is available until 2015 only. Let's see what can be done to match the election data. 


#BEA Regional Income Data: Current Transfer receipts of individuals from Governments
##API error, this data is not loading.
beaPercapita_Current_Transfer <- list(
    'UserID' = beaKey ,
    'Method' = 'GetData',
    'datasetname' = 'RegionalIncome',
    'TableName' = 'CA30' ,
    'LineCode' = '130',
    'Year' = '1992, 1996, 2000, 2004, 2008, 2012' ,
    'GeoFips' = 'COUNTY' ,
    'ResultFormat' = 'json'
);
beaPercapita_Current_Transfer <- beaGet(beaPercapita_Current_Transfer)
names(beaPercapita_Current_Transfer)[6:11]<-c("1992", "1996", "2000", "2004", "2008", "2012")
PerCapitaCurrentTransfer <- gather(beaPercapita_Current_Transfer, 6:11, key="Year", value="PCCT")
names(PerCapitaCurrentTransfer)[4]<-"PCCT_Label"


#BEA Regional Income Data: Adjustment for Residence equals the inflows to that county minus the outflows from that county
beaAdjustment_Residence <- list(
    'UserID' = beaKey ,
    'Method' = 'GetData',
    'datasetname' = 'RegionalIncome',
    'TableName' = 'CA91' ,
    'LineCode' = '30',
    'Year' = '1992, 1996, 2000, 2004, 2008, 2012' ,
    'GeoFips' = 'COUNTY' ,
    'ResultFormat' = 'json'
);
beaAdjustment_Residence <- beaGet(beaAdjustment_Residence)
names(beaAdjustment_Residence)[6:11]<-c("1992", "1996", "2000", "2004", "2008", "2012")
AdjustmentResidence <- gather(beaAdjustment_Residence, 6:11, key="Year", value="Adj_res")
names(AdjustmentResidence)[4]<-"Adj_res_Label"

#Removing all previous untidy dataframes
rm(beaPop, beaPCI, beaPercapita_Current_Transfer, beaAdjustment_Residence)

```


```{r blsdata, echo=FALSE,}
#BLS Data on Unemployment by county, clean data, remove unnecessary rows
unemp92 <- read_excel('laucnty92.xlsx')
unemp92 <- separate(unemp92, County, into = c("County.name", "State"), sep=",")
unemp92 <- unemp92[-c(3217:3219), ]
unemp96 <- read_excel('laucnty96.xlsx')
unemp96 <- separate(unemp96, County, into = c("County.name", "State"), sep=",")
unemp96 <- unemp96[-c(3218:3220), ]
unemp00 <- read_excel('laucnty00.xlsx')
unemp00 <- separate(unemp00, County, into = c("County.name", "State"), sep=",")
unemp00 <- unemp00[-c(3218:3220), ]
unemp04 <- read_excel('laucnty04.xlsx')
unemp04 <- separate(unemp04, County, into = c("County.name", "State"), sep=",")
unemp04 <- unemp04[-c(3218:3220), ]
unemp08 <- read_excel('laucnty08.xlsx')
unemp08 <- separate(unemp08, County, into = c("County.name", "State"), sep=",")
unemp08 <- unemp08[-c(3218:3220), ]
unemp12 <- read_excel('laucnty12.xlsx')
unemp12 <- separate(unemp12, County, into = c("County.name", "State"), sep=",")
unemp12 <- unemp12[-c(3220:3222), ]

#Combine all the dataframes from different years into one dataframe
Unemployment <- bind_rows(unemp92, unemp96, unemp00, unemp04, unemp08, unemp12, .id = NULL)
names(Unemployment)[names(Unemployment)=="County.name"] <- "county"
names(Unemployment)[names(Unemployment)=="State"] <- "state"
names(Unemployment)[names(Unemployment)=="County Code"] <- "county.fips"
names(Unemployment)[names(Unemployment)=="State FIPS Code"] <- "state.fips"
names(Unemployment)[names(Unemployment)=="Year"] <- "year"

Unemployment$county <- strsplit(Unemployment$county, " County") #Remove the word County from the county names
Unemployment$county <- tolower(Unemployment$county) #Changed the county names to lowercase
View(Unemployment)
Unemployment <- unite(Unemployment, state.fips, county.fips, col ="county.fips", sep="") #Combine two columns to make them into one.

#The states that appeared as NA in this dataframe represented DC, hence the NAs will be changed to DC
Unemployment <- replace_na(Unemployment, list(state="DC", Unemployment$state))

#Converting from character to numeric for merging purposes
Unemployment$county.fips <- as.numeric(Unemployment$county.fips)
Unemployment$year <- as.numeric(Unemployment$year)

#Removing Alaska and Puerto Rico


#Remove untidy dataframes from the environment
rm(unemp92, unemp96, unemp00, unemp04, unemp08, unemp12) 


```








```{r census, echo=FALSE, include=FALSE}
#Census Data
geo <- geo.make(state = '*', county = '*', combine = F, combine.term = "aggregate", check = FALSE, key = "auto")
male <- acs.fetch(endyear =2015, span =5, geo, dataset = 'acs', variable = 'B01001_002', col.names = 'auto')

estimate(male)
estimate(male) -> male.estimate

cbind(male.estimate, standard.error(male)) -> male1
rownames(male1)

rownames(male1) %>% cbind(male1) -> male1
```

```{r Merging, echo=FALSE, include=FALSE}
Dataset1 <- merge(Unemployment, election_data, by= c('county.fips', 'year', 'county'), all.x = TRUE)
```


